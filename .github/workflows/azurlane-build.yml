name: APK AzurLane JMBQ Build Work
# 手动触发，B服默认配置
on:
  workflow_dispatch:
    inputs:
      server_name:
        description: '区服名称-必须（英文字母！示例：Bilibili）'
        required: true
        type: string
        default: 'Bilibili'
      download_url:
        description: 'APK直链（国外云盘优先，如Google Drive）'
        required: true
        type: string
        default: 'https://drive.google.com/uc?export=download&id=1UCXwbDVx1HVoslmZaShPtWNYSMiUe62z'

jobs:
  build:
    runs-on: ubuntu-latest
    # 权限配置
    permissions:
      contents: write
      actions: read
    # 修复核心：env块内不引用自身变量，变量名加引号
    env:
      APP_VERSION: "9.6.11"  # 固定版本号，不被引用
      APK_NAME: "azurlane-${{ github.event.inputs.server_name }}.apk"
      7Z_NAME: "${{ github.event.inputs.server_name }}-V.9.6.11.7z"  # 直接写版本号，不引用env

    steps:
      # 步骤1：浅克隆仓库
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：安装基础依赖
      - name: Install Dependencies
        run: |
          sudo apt update -y && sudo apt install -y p7zip-full unzip curl wget -y

      # 步骤3：配置Java 17
      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      # 步骤4：配置Android SDK
      - name: Set up Android SDK
        uses: android-actions/setup-android@v4
        with:
          android-sdk-version: 35
          build-tools-version: 35.0.0

      # 步骤5：下载APK+校验
      - name: Download & Check APK
        run: |
          wget -O ${{ env.APK_NAME }} ${{ github.event.inputs.download_url }} --no-check-certificate
          if [ ! -f ${{ env.APK_NAME }} ]; then exit 1; fi
          APK_SIZE=$(du -b ${{ env.APK_NAME }} | awk '{print $1}')
          if [ $APK_SIZE -lt $((1400 * 1024 * 1024)) ]; then exit 1; fi

      # 步骤6：执行构建脚本
      - name: Build APK
        run: |
          chmod +x merge_build.sh
          ./merge_build.sh "${{ github.event.inputs.server_name }}" "${{ env.APK_NAME }}"

      # 步骤7：7z分卷压缩
      - name: Compress to 7z Parts
        run: |
          7z a -v2000M ${{ env.7Z_NAME }} *.apk
          if [ ! -f ${{ env.7Z_NAME }}.001 ]; then exit 1; fi

      # 步骤8：创建Release
      - name: Release Assets
        uses: ncipollo/release-action@v1.14.0
        with:
          tag: "9.6.11-APK-${{ github.event.inputs.server_name }}"
          name: "AzurLane JMBQ 9.6.11 [${{ github.event.inputs.server_name }}] Build"
          artifacts: "${{ env.7Z_NAME }}.*"
          allowUpdates: true
          body: |
            ### 区服：${{ github.event.inputs.server_name }}
            ### 版本：9.6.11
          token: ${{ github.token }}
