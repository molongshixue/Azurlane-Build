name: APK AzurLane JMBQ Build Work
# æ‰‹åŠ¨è§¦å‘ï¼Œé…ç½®Bæœé»˜è®¤å‚æ•°ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥
on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'åŒºæœåç§°-å¿…é¡»ï¼ˆè‹±æ–‡å­—æ¯ï¼ç¤ºä¾‹ï¼šBilibiliï¼‰'
        required: true
        type: string
        default: 'Bilibili'  # Bæœé»˜è®¤å€¼ï¼Œç›´æ¥ç”¨
      download_url:
        description: 'APKç›´é“¾ï¼ˆå›½å¤–äº‘ç›˜ä¼˜å…ˆï¼Œå¦‚Google Driveï¼‰'
        required: true
        type: string
        default: 'https://drive.google.com/uc?export=download&id=1UCXwbDVx1HVoslmZaShPtWNYSMiUe62z'  # ä½ çš„Bæœç›´é“¾

jobs:
  build:
    runs-on: ubuntu-latest
    # å¿…å¤‡æƒé™ï¼šåˆ›å»ºReleaseã€ä¸Šä¼ èµ„äº§ã€è¯»å–ç¯å¢ƒ
    permissions:
      contents: write
      actions: read
    # ä¿®å¤æ ¸å¿ƒï¼šåˆå¹¶ç‰ˆæœ¬å˜é‡ï¼ŒåŒä¸€envå—æ— å†…éƒ¨å¼•ç”¨ï¼Œè§£å†³è¯­æ³•æŠ¥é”™
    env:
      APP_VERSION: 9.6.11        # ç¢§è“èˆªçº¿Bæœå½“å‰ç‰ˆæœ¬å·
      APK_NAME: azurlane-${{ github.event.inputs.server_name }}.apk  # ä¸‹è½½çš„APKå‘½å
      7Z_NAME: ${{ github.event.inputs.server_name }}-V.${{ env.APP_VERSION }}.7z  # 7zåˆ†å·åŸºç¡€å

    steps:
      # æ­¥éª¤1ï¼šæµ…å…‹éš†ä»“åº“ä»£ç ï¼ˆæå‡é€Ÿåº¦ï¼Œæ‹‰å–merge_build.shï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # æ­¥éª¤2ï¼šå®‰è£…UbuntuåŸºç¡€ä¾èµ–ï¼ˆ7zå‹ç¼©/SDKè§£å‹/ç½‘ç»œå·¥å…·ï¼Œå¿…è£…ï¼‰
      - name: Install Ubuntu Basic Dependencies
        run: |
          sudo apt update -y && sudo apt install -y p7zip-full p7zip-rar unzip curl wget jq -y
          # éªŒè¯å…³é”®å·¥å…·å®‰è£…
          echo "7zç‰ˆæœ¬ï¼š" && 7z --version
          echo "curlç‰ˆæœ¬ï¼š" && curl --version

      # æ­¥éª¤3ï¼šé…ç½®Java 17ï¼ˆAndroidæ„å»ºå¿…éœ€ï¼Œç¨³å®šç‰ˆtemurinï¼‰
      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle  # ç¼“å­˜gradleï¼Œåç»­æ„å»ºæ›´å¿«

      # æ­¥éª¤4ï¼šé…ç½®Android SDK+Build-Tools 35.0.0ï¼ˆAPKå¤„ç†å¿…éœ€ï¼‰
      - name: Set up Android SDK
        uses: android-actions/setup-android@v4
        with:
          android-sdk-version: 35
          build-tools-version: 35.0.0

      # æ­¥éª¤5ï¼šä¸‹è½½APK+å®Œæ•´æ€§æ ¡éªŒï¼ˆè§£å†³æ–‡ä»¶æŸåï¼Œè¿‡æ»¤æ®‹ç¼º/ç©ºæ–‡ä»¶ï¼‰
      - name: Download APK & Check Integrity
        run: |
          # ç”¨wgetä¸‹è½½ï¼Œå…¼å®¹Google Driveç›´é“¾ï¼Œå¿½ç•¥è¯ä¹¦é—®é¢˜
          wget -O ${{ env.APK_NAME }} ${{ github.event.inputs.download_url }} --no-check-certificate
          # æ ¡éªŒ1ï¼šæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f ${{ env.APK_NAME }} ]; then
            echo "âŒ é”™è¯¯ï¼šAPKä¸‹è½½å¤±è´¥ï¼Œç›´é“¾æ— æ•ˆ/æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          # æ ¡éªŒ2ï¼šæ–‡ä»¶å¤§å°ï¼ˆç¢§è“èˆªçº¿APKæœ€å°1.4Gï¼Œè¿‡æ»¤æ®‹ç¼ºæ–‡ä»¶ï¼‰
          APK_SIZE=$(du -b ${{ env.APK_NAME }} | awk '{print $1}')
          MIN_SIZE=$((1400 * 1024 * 1024))
          if [ $APK_SIZE -lt $MIN_SIZE ]; then
            echo "âŒ é”™è¯¯ï¼šAPKæ®‹ç¼ºï¼Œå½“å‰å¤§å°$((APK_SIZE/1024/1024))Mï¼Œéœ€è‡³å°‘1400M"
            exit 1
          fi
          echo "âœ… APKä¸‹è½½æˆåŠŸï¼Œå¤§å°ï¼š$((APK_SIZE/1024/1024))Mï¼Œå®Œæ•´æ€§æ ¡éªŒé€šè¿‡"

      # æ­¥éª¤6ï¼šæ‰§è¡Œæ ¸å¿ƒæ„å»ºè„šæœ¬ï¼ˆæ£€æŸ¥è„šæœ¬å­˜åœ¨+èµ‹æƒ+æ‰§è¡Œï¼Œæ•è·é”™è¯¯ï¼‰
      - name: Build APK with Custom Script
        run: |
          # æ£€æŸ¥merge_build.shæ˜¯å¦å­˜åœ¨ï¼ˆä»“åº“æ ¹ç›®å½•å¿…é¡»æœ‰ï¼‰
          if [ ! -f merge_build.sh ]; then
            echo "âŒ é”™è¯¯ï¼šæ ¸å¿ƒè„šæœ¬merge_build.shä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ä»“åº“æ ¹ç›®å½•"
            exit 1
          fi
          chmod +x merge_build.sh
          # ä¼ å…¥å‚æ•°ï¼šåŒºæœå + ä¸‹è½½çš„APKè·¯å¾„
          ./merge_build.sh "${{ github.event.inputs.server_name }}" "${{ env.APK_NAME }}"
        continue-on-error: false  # è„šæœ¬å¤±è´¥ç›´æ¥ç»ˆæ­¢ï¼Œä¸ç»§ç»­åç»­æ­¥éª¤

      # æ­¥éª¤7ï¼š7zåˆ†å·å‹ç¼©ï¼ˆ2000M/å·ï¼Œé€‚é…GitHub Releaseå•æ–‡ä»¶2Gé™åˆ¶ï¼‰
      - name: Split Compress APK to 7z Parts
        run: |
          # åˆ†å·å‹ç¼©ï¼š-v2000M=æ¯å·2Gï¼Œ-a=æ·»åŠ å‹ç¼©ï¼Œä¿ç•™åŸAPK
          7z a -v2000M ${{ env.7Z_NAME }} *.apk
          # æŸ¥çœ‹å‹ç¼©æ–‡ä»¶ï¼ŒéªŒè¯æ˜¯å¦ç”Ÿæˆ
          ls -lh ${{ env.7Z_NAME }}.*
          # æ ¡éªŒä¸»åˆ†å·ï¼ˆ001ï¼‰æ˜¯å¦å­˜åœ¨
          if [ ! -f ${{ env.7Z_NAME }}.001 ]; then
            echo "âŒ é”™è¯¯ï¼š7zåˆ†å·å‹ç¼©å¤±è´¥ï¼Œæœªç”Ÿæˆ001ä¸»æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… 7zåˆ†å·å‹ç¼©æˆåŠŸï¼Œäº§ç‰©ï¼š$(ls ${{ env.7Z_NAME }}.* | wc -l) ä¸ªæ–‡ä»¶"

      # æ­¥éª¤8ï¼šè‡ªåŠ¨åˆ›å»ºReleaseå¹¶ä¸Šä¼ æ‰€æœ‰åˆ†å·ï¼ˆå¸¦åŒºæœæ ‡è¯†ï¼Œæ”¯æŒæ›´æ–°ï¼‰
      - name: Release & Upload All Assets
        uses: ncipollo/release-action@v1.14.0  # å›ºå®šç‰ˆæœ¬ï¼Œé¿å…å…¼å®¹é—®é¢˜
        with:
          tag: ${{ env.APP_VERSION }}-APK-${{ github.event.inputs.server_name }}
          name: AzurLane JMBQ ${{ env.APP_VERSION }} [${{ github.event.inputs.server_name }}] Build APK
          artifacts: ${{ env.7Z_NAME }}.*  # ä»…ä¸Šä¼ 7zåˆ†å·ï¼Œç²¾å‡†åŒ¹é…
          allowUpdates: true              # å…è®¸æ›´æ–°å·²æœ‰Release
          removeArtifacts: true           # æ›´æ–°æ—¶åˆ é™¤æ—§èµ„äº§ï¼Œé¿å…é‡å¤
          draft: false                    # ç›´æ¥å‘å¸ƒæ­£å¼ç‰ˆï¼Œæ— éœ€æ‰‹åŠ¨ç¡®è®¤
          prerelease: false               # éé¢„å‘å¸ƒç‰ˆæœ¬
          body: |
            ### ğŸ“Œ æ„å»ºä¿¡æ¯
            æœåŠ¡å™¨ï¼š${{ github.event.inputs.server_name }}
            æ¸¸æˆç‰ˆæœ¬ï¼š${{ env.APP_VERSION }}
            APKç›´é“¾æ¥æºï¼š${{ github.event.inputs.download_url }}
            æ„å»ºæ—¶é—´ï¼š${{ github.run_at }}

            <details>
              <summary>ğŸ“ ä¸­æ–‡å®‰è£…è¯´æ˜ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
                1. ä¸‹è½½ä¸‹æ–¹<b>æ‰€æœ‰</b>ä»¥${{ env.7Z_NAME }}ä¸ºå‰ç¼€çš„7zåˆ†å·æ–‡ä»¶ï¼›
                2. å°†æ‰€æœ‰åˆ†å·æ”¾åœ¨<b>åŒä¸€æ–‡ä»¶å¤¹</b>ï¼Œå³é”®001æ–‡ä»¶é€‰æ‹©ã€Œ7zâ†’è§£å‹åˆ°å½“å‰æ–‡ä»¶å¤¹ã€ï¼›
                3. è§£å‹åæ‰¾åˆ°APKæ–‡ä»¶ï¼Œå®‰å“8.0+éœ€å¼€å¯ã€ŒæœªçŸ¥æ¥æºå®‰è£…ã€åç›´æ¥å®‰è£…ï¼›
                4. å®‰è£…å¤±è´¥è¯·æ£€æŸ¥ï¼šåˆ†å·æ˜¯å¦é½å…¨/APKæ˜¯å¦æ®‹ç¼º/è§£å‹å·¥å…·æ˜¯å¦ä¸º7zã€‚
            </details>
            
            <details>
              <summary>ğŸ“ English Installation Instructionsï¼ˆClick to expandï¼‰</summary>
                1. Download <b>all</b> 7z split files prefixed with ${{ env.7Z_NAME }} below;
                2. Place all split files in the <b>same folder</b>, right-click the 001 file and select ã€Œ7zâ†’Extract Hereã€;
                3. Find the APK file after extraction, enable ã€ŒInstall from unknown sourcesã€ (Android 8.0+) and install directly;
                4. If installation fails, check: complete split files / intact APK / 7z decompression tool.
            </details>
          token: ${{ github.token }}  # GitHubå†…ç½®ä»¤ç‰Œï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
