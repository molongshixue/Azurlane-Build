name: APK AzurLane JMBQ Build Work
on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'åŒºæœåç§°-å¿…é¡»ï¼ˆå¿…é¡»æ˜¯è‹±æ–‡å­—æ¯ï¼ä¾‹å¦‚ Bilibiliï¼Œå°æœå’Œå¤–æœè¯·ä½¿ç”¨XAPKæ„å»ºæµç¨‹ï¼‰'
        required: true
        type: string
        default: 'Bilibili' # é»˜è®¤ä¸ºBæœï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥
      download_url:
        description: 'APKä¸‹è½½é“¾æ¥ï¼ˆåªèƒ½å¡«å…¥ç›´é“¾ï¼Œæœ€å¥½ä½¿ç”¨å›½å¤–äº‘ç›˜çš„ç›´é“¾ï¼Œä¾‹å¦‚Googleäº‘ç›˜ï¼‰'
        required: true
        type: string
        default: 'https://drive.google.com/uc?export=download&id=1UCXwbDVx1HVoslmZaShPtWNYSMiUe62z' # é»˜è®¤ä¸ºä½ Bæœçš„Google Driveç›´é“¾

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # èµ‹äºˆåˆ›å»ºRelease/å†™å…¥ä»“åº“çš„æƒé™
      actions: read    # æ–°å¢ï¼šè¯»å–Actionç¯å¢ƒä¿¡æ¯
    # å®šä¹‰ç¼ºå¤±çš„æ ¸å¿ƒç¯å¢ƒå˜é‡ï¼ˆå¯æ ¹æ®éœ€è¦ä¿®æ”¹ç‰ˆæœ¬å·ï¼‰
    env:
      JMBQ_VERSION: 9.6.11 # ç¢§è“èˆªçº¿å½“å‰ç‰ˆæœ¬å·ï¼ˆBæœ9.6.11ï¼‰
      VERSION: ${{ env.JMBQ_VERSION }} # å…³è”ç‰ˆæœ¬å·ï¼Œä¿æŒä¸€è‡´
      APK_NAME: azurlane-${{ github.event.inputs.server_name }}.apk # ä¸‹è½½çš„APKå‘½å
      7Z_NAME: ${{ github.event.inputs.server_name }}-V.${{ env.VERSION }}.7z # åˆ†å·å‹ç¼©åŒ…åŸºç¡€å

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆæ‹‰å–merge_build.shç­‰æ ¸å¿ƒè„šæœ¬ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # æµ…å…‹éš†ï¼Œæå‡é€Ÿåº¦

      # æ­¥éª¤2ï¼šå®‰è£…UbuntuåŸºç¡€ä¾èµ–ï¼ˆ7z/è§£å‹/ç½‘ç»œå·¥å…·ï¼Œè§£å†³å‹ç¼©/SDKå®‰è£…é—®é¢˜ï¼‰
      - name: Install Ubuntu basic dependencies
        run: |
          sudo apt update -y && sudo apt install -y p7zip-full p7zip-rar unzip curl wget jq -y
          # éªŒè¯7zå®‰è£…
          7z --version
          # éªŒè¯curlå®‰è£…
          curl --version

      # æ­¥éª¤3ï¼šè®¾ç½®Java JDK 17ï¼ˆAndroidæ„å»ºå¿…éœ€ï¼‰
      - name: Setup Java JDK
        uses: actions/setup-java@v4 # å‡çº§åˆ°v4ï¼Œæ›´ç¨³å®š
        with:
          java-version: "17"
          distribution: "temurin" # æ›¿æ¢adoptä¸ºtemurinï¼ˆå®˜æ–¹ç»´æŠ¤ï¼Œæ›´ç¨³å®šï¼‰
          cache: gradle # ç¼“å­˜gradleï¼Œæå‡åç»­æ„å»ºé€Ÿåº¦

      # æ­¥éª¤4ï¼šè®¾ç½®Android SDKï¼ˆå‡çº§åˆ°v4ï¼Œé€‚é…æ–°ç‰ˆï¼‰
      - name: Set up Android SDK
        uses: android-actions/setup-android@v4
        with:
          android-sdk-version: 35 # åŒ¹é…build-toolsç‰ˆæœ¬
          build-tools-version: 35.0.0 # ç›´æ¥æŒ‡å®šï¼Œæ— éœ€æ‰‹åŠ¨å®‰è£…

      # æ­¥éª¤5ï¼šæ‰‹åŠ¨ä¸‹è½½APKå¹¶åšã€å®Œæ•´æ€§åˆæ­¥æ ¡éªŒã€‘ï¼ˆè§£å†³APKæŸåé—®é¢˜ï¼‰
      - name: Download APK from direct link and check integrity
        run: |
          # ç”¨wgetä¸‹è½½APKï¼ˆæ”¯æŒGoogle Driveç›´é“¾ï¼Œè‡ªåŠ¨å¤„ç†é‡å®šå‘ï¼‰
          wget -O ${{ env.APK_NAME }} ${{ github.event.inputs.download_url }} --no-check-certificate
          # æ ¡éªŒ1ï¼šæ£€æŸ¥APKæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f ${{ env.APK_NAME }} ]; then
            echo "ERROR: APKæ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œç›´é“¾æ— æ•ˆæˆ–æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1 # ç»ˆæ­¢å·¥ä½œæµ
          fi
          # æ ¡éªŒ2ï¼šæ£€æŸ¥APKæ–‡ä»¶å¤§å°ï¼ˆç¢§è“èˆªçº¿APKæœ€å°1.4Gï¼Œè¿‡æ»¤ç©ºæ–‡ä»¶/æ®‹ç¼ºæ–‡ä»¶ï¼‰
          APK_SIZE=$(du -b ${{ env.APK_NAME }} | awk '{print $1}')
          MIN_SIZE=$((1400 * 1024 * 1024)) # 1.4Gå­—èŠ‚æ•°
          if [ $APK_SIZE -lt $MIN_SIZE ]; then
            echo "ERROR: APKæ–‡ä»¶æ®‹ç¼ºï¼Œå¤§å°ä¸º$((APK_SIZE/1024/1024))Mï¼Œå°äºæœ€å°1400Mï¼"
            exit 1 # ç»ˆæ­¢å·¥ä½œæµ
          fi
          echo "APKä¸‹è½½æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$((APK_SIZE/1024/1024))Mï¼Œå®Œæ•´æ€§åˆæ­¥æ ¡éªŒé€šè¿‡ï¼"

      # æ­¥éª¤6ï¼šæ‰§è¡Œæ„å»ºæµç¨‹ï¼ˆèµ‹äºˆè„šæœ¬æƒé™+æ‰§è¡Œ+æ•è·é”™è¯¯ï¼‰
      - name: Build APK with custom script
        run: |
          # ç¡®ä¿æ„å»ºè„šæœ¬å­˜åœ¨
          if [ ! -f merge_build.sh ]; then
            echo "ERROR: æ ¸å¿ƒæ„å»ºè„šæœ¬merge_build.shä¸å­˜åœ¨ï¼è¯·æ£€æŸ¥ä»“åº“æ˜¯å¦åŒ…å«è¯¥æ–‡ä»¶ï¼"
            exit 1
          fi
          # èµ‹äºˆæ‰§è¡Œæƒé™
          chmod +x merge_build.sh
          # æ‰§è¡Œè„šæœ¬å¹¶ä¼ å…¥å‚æ•°ï¼ˆåŒºæœå+APKè·¯å¾„ï¼Œæ›¿ä»£åŸç›´é“¾ï¼Œæ›´çµæ´»ï¼‰
          ./merge_build.sh "${{ github.event.inputs.server_name }}" "${{ env.APK_NAME }}"
        continue-on-error: false # è„šæœ¬æ‰§è¡Œå¤±è´¥ç›´æ¥ç»ˆæ­¢ï¼Œä¸ç»§ç»­

      # æ­¥éª¤7ï¼šåˆ†å·å‹ç¼©æ„å»ºåçš„APKï¼ˆæŒ‰2Gåˆ†å·ï¼Œé€‚é…GitHub Releaseå•æ–‡ä»¶2Gé™åˆ¶ï¼‰
      - name: Split compress APK to 7z parts
        run: |
          # 7zåˆ†å·å‹ç¼©ï¼šæ¯å·2000Mï¼ˆ2Gï¼‰ï¼Œæ ¼å¼7z.001/7z.002...ï¼Œä¿ç•™åŸæ–‡ä»¶
          7z a -v2000M ${{ env.7Z_NAME }} *.apk
          # æŸ¥çœ‹å‹ç¼©åçš„åˆ†å·æ–‡ä»¶
          ls -lh ${{ env.7Z_NAME }}.*
          # æ ¡éªŒåˆ†å·æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f ${{ env.7Z_NAME }}.001 ]; then
            echo "ERROR: 7zåˆ†å·å‹ç¼©å¤±è´¥ï¼Œæœªç”Ÿæˆ001ä¸»æ–‡ä»¶ï¼"
            exit 1
          fi

      # æ­¥éª¤8ï¼šåˆ›å»º Release å¹¶ä¸Šä¼ æ‰€æœ‰åˆ†å·æ–‡ä»¶ï¼ˆä¼˜åŒ–å‚æ•°ï¼Œæ›´ç¨³å®šï¼‰
      - name: Release and Upload Assets
        uses: ncipollo/release-action@v1.14.0 # æŒ‡å®šç‰ˆæœ¬ï¼Œé¿å…è‡ªåŠ¨å‡çº§å‡ºé—®é¢˜
        with:
          tag: "${{ env.JMBQ_VERSION }}-APK-${{ github.event.inputs.server_name }}" # æ ‡ç­¾å¢åŠ åŒºæœåï¼Œæ”¯æŒå¤šæœåŒæ—¶å‘å¸ƒ
          name: "AzurLane JMBQ ${{ env.JMBQ_VERSION }} [${{ github.event.inputs.server_name }}] Build APK" # åç§°å¢åŠ åŒºæœå
          artifacts: "${{ env.7Z_NAME }}.*" # ç²¾å‡†åŒ¹é…åˆ†å·æ–‡ä»¶ï¼Œé¿å…ä¸Šä¼ æ— å…³æ–‡ä»¶
          allowUpdates: true # å…è®¸æ›´æ–°å·²æœ‰Release
          removeArtifacts: true # æ–°å¢ï¼šæ›´æ–°Releaseæ—¶åˆ é™¤æ—§èµ„äº§
          draft: false # ç›´æ¥å‘å¸ƒæ­£å¼Releaseï¼Œæ— éœ€æ‰‹åŠ¨ç¡®è®¤
          prerelease: false # éé¢„å‘å¸ƒç‰ˆæœ¬
          body: |
            ### ğŸ“Œ åŒºæœç‰ˆæœ¬
            æœåŠ¡å™¨ï¼š${{ github.event.inputs.server_name }}
            æ¸¸æˆç‰ˆæœ¬ï¼š${{ env.JMBQ_VERSION }}
            APKç›´é“¾æ¥æºï¼š${{ github.event.inputs.download_url }}

            <details>
              <summary>ğŸ“ ä¸­æ–‡å®‰è£…è¯´æ˜ - ç‚¹å‡»å±•å¼€</summary>
                1. ä¸‹è½½ä¸‹æ–¹<b>æ‰€æœ‰</b>ä»¥${{ env.7Z_NAME }}ä¸ºå‰ç¼€çš„7zåˆ†å·æ–‡ä»¶ï¼ˆ001/002/...ï¼‰ï¼›
                2. å°†æ‰€æœ‰åˆ†å·æ”¾åœ¨<b>åŒä¸€æ–‡ä»¶å¤¹</b>ï¼Œå³é”®é€‰æ‹©ã€Œ7zâ†’è§£å‹åˆ°å½“å‰æ–‡ä»¶å¤¹ã€ï¼ˆä»…éœ€ç‚¹å‡»001æ–‡ä»¶ï¼‰ï¼›
                3. è§£å‹åæ‰¾åˆ°APKæ–‡ä»¶ï¼Œç›´æ¥å®‰è£…ï¼ˆå®‰å“8.0+éœ€å¼€å¯ã€ŒæœªçŸ¥æ¥æºå®‰è£…ã€ï¼‰ï¼›
                4. è‹¥å®‰è£…å¤±è´¥ï¼Œæ£€æŸ¥APKå®Œæ•´æ€§æˆ–æ›´æ¢è§£å‹å·¥å…·ã€‚
            </details>
            
            <details>
              <summary>ğŸ“ English Installation Instructions - Click to expand</summary>
                1. Download <b>all</b> 7z split files (001/002/...) prefixed with ${{ env.7Z_NAME }} below;
                2. Place all split files in the <b>same folder</b>, right-click and select ã€Œ7zâ†’Extract Hereã€(only need to click the 001 file);
                3. Find the APK file after extraction and install it directly (Android 8.0+ needs to enable ã€ŒInstall from unknown sourcesã€);
                4. If installation fails, check the APK integrity or replace the decompression tool.
            </details>
          token: ${{ github.token }} # è‡ªåŠ¨ä½¿ç”¨GitHubå†…ç½®ä»¤ç‰Œï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
